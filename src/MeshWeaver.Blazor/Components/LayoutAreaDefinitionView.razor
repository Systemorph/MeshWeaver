@inherits BlazorView<LayoutAreaDefinitionControl, LayoutAreaDefinitionView>


<a href="@ViewModel.Definition.Url" class="card layout-area-card text-decoration-none">
    <div class="layout-area-card-header">
        <h5 class="layout-area-card-title">@ViewModel.Definition.Title</h5>
    </div>
    <div class="layout-area-card-content">
        <img src="@imgUrl" class="layout-area-card-image" alt="@Alt">
        <div class="layout-area-card-text">
            <p class="layout-area-card-description" title="@(ViewModel.Definition.Description ?? "")">@(ViewModel.Definition.Description ?? "")</p>
        </div>
    </div>
</a>

@code {
    private string? imgUrl;
    private string  Alt => $"Thumbnail for {ViewModel.Definition.Title}";
    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        imgUrl = await GetImageUrlAsync();
    }

    private async Task<string> GetImageUrlAsync()
    {
        // First priority: explicit ThumbnailUrl from definition
        if (!string.IsNullOrEmpty(ViewModel.Definition.ThumbnailUrl))
        {
            return AddCacheBuster(ViewModel.Definition.ThumbnailUrl);
        }

        var isDark = await IsDarkModeAsync();
        var selectedUrl = isDark 
            ? ViewModel.DarkThumbnailUrl 
            : ViewModel.LightThumbnailUrl;

        if (!string.IsNullOrEmpty(selectedUrl))
        {
            return AddCacheBuster(selectedUrl);
        }

        // Fallback: use standard ImageUrl or default placeholder
        var fallbackUrl = ViewModel.Definition.ImageUrl ?? GetDefaultImage();
        return AddCacheBuster(fallbackUrl);
    }

    private string AddCacheBuster(string url)
    {
        if (string.IsNullOrEmpty(ViewModel.ThumbnailHash))
            return url;

        var separator = url.Contains('?') ? "&" : "?";
        return $"{url}{separator}v={ViewModel.ThumbnailHash}";
    }

    private string GetDefaultImage()
    {
        // SVG placeholder image
        return "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjRjVGNUY1Ii8+CjxwYXRoIGQ9Ik00MCAyNUM0Ni42Mjc0IDI1IDUyIDMwLjM3MjYgNTIgMzdDNTIgNDMuNjI3NCA0Ni42Mjc0IDQ5IDQwIDQ5QzMzLjM3MjYgNDkgMjggNDMuNjI3NCAyOCAzN0MyOCAzMC4zNzI2IDMzLjM3MjYgMjUgNDAgMjVaIiBmaWxsPSIjRDREREREIi8+CjxwYXRoIGQ9Ik0yNCA1NUg1NlY0NUgyNFY1NVoiIGZpbGw9IiNEREREREQiLz4KPHN2Zz4K";
    }

}
