@using MeshWeaver.ContentCollections
@using MeshWeaver.Messaging
@using Microsoft.Extensions.DependencyInjection
@inherits BlazorView<FileBrowserControl,FileBrowserView>

<FileBrowser CollectionName="@Collection" CurrentPath="@Path" CreatePath="@PathCreation" TopLevelPath="@TopLevelPath"  Embed="@true"></FileBrowser>

@code
{
    private string? Collection;
    private string? Path;
    private bool PathCreation;
    private string? TopLevelPath;
    private ContentCollectionConfig? CollectionConfiguration;

    protected override void BindData()
    {
        base.BindData();
        DataBind(ViewModel.Collection, x => x.Collection);
        DataBind(ViewModel.Path, x => x.Path, defaultValue: "/");
        DataBind(ViewModel.PathCreation, x => x.PathCreation);
        DataBind(ViewModel.TopLevelPath, x => x.TopLevelPath);
        DataBind(ViewModel.CollectionConfiguration, x => x.CollectionConfiguration);
    }

    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();

        if (CollectionConfiguration is not null && Collection is not null)
        {
            await InitializeCollectionIfNeededAsync();
        }
    }

    private async Task InitializeCollectionIfNeededAsync()
    {
        if (Collection is null || CollectionConfiguration is null)
            return;

        var contentService = Hub.ServiceProvider.GetRequiredService<IContentService>();

        // Initialize the collection - the service handles everything
        await contentService.InitializeCollectionAsync(CollectionConfiguration, CancellationToken.None);
    }
}
